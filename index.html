<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOMPETISI ROKET AIR LABIABA INDONESIA</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <!-- Library untuk export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Library untuk membaca Excel -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f8ff;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            margin: 0 0 20px 0;
            font-size: 2.2rem;
            letter-spacing: 1px;
        }
        
        .header-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .info-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1rem;
            font-weight: bold;
        }
        
        .login-section {
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
            background-color: #f5f9ff;
        }
        
        .login-box {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .login-box h2 {
            margin-top: 0;
            color: #1e3c72;
            margin-bottom: 30px;
        }
        
        .login-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .login-btn {
            padding: 15px;
            background-color: #2a5298;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            background-color: #1e3c72;
            transform: translateY(-2px);
        }
        
        .password-section {
            display: none;
            margin-top: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e3c72;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            border-color: #2a5298;
            outline: none;
        }
        
        .operator-panel, .viewer-panel {
            display: none;
            padding: 20px;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2a5298;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #2a5298;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background-color: #1e3c72;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #d9534f;
        }
        
        .btn-danger:hover {
            background-color: #c9302c;
        }
        
        .btn-success {
            background-color: #5cb85c;
        }
        
        .btn-success:hover {
            background-color: #449d44;
        }
        
        .btn-warning {
            background-color: #f0ad4e;
        }
        
        .btn-warning:hover {
            background-color: #ec971f;
        }
        
        .btn-info {
            background-color: #5bc0de;
        }
        
        .btn-info:hover {
            background-color: #31b0d5;
        }
        
        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .manual-input, .file-upload {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #ddd;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .manual-input h3, .file-upload h3 {
            margin-top: 0;
            color: #1e3c72;
            margin-bottom: 20px;
        }
        
        .file-upload-preview {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #ddd;
            margin-top: 15px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-upload-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .file-upload-preview th {
            background-color: #f0f0f0;
            padding: 8px;
            text-align: left;
            font-weight: 600;
        }
        
        .file-upload-preview td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
        }
        
        .upload-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .upload-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .upload-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .event-config {
            background-color: #f0f8ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #2a5298;
        }
        
        .event-config h3 {
            margin-top: 0;
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .event-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            border: 1px solid #ddd;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #2a5298;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f7ff;
        }
        
        .top-50 {
            background-color: #e8f4ff !important;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .ranking-1 {
            background-color: #ffeb3b !important;
            font-weight: bold;
            color: #000;
        }
        
        .ranking-2 {
            background-color: #e0e0e0 !important;
            font-weight: bold;
        }
        
        .ranking-3 {
            background-color: #ffcc80 !important;
            font-weight: bold;
        }
        
        .best-score {
            background-color: #d4edda !important;
            font-weight: bold;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .score-input.best-score {
            background-color: #d4edda !important;
            font-weight: bold;
        }
        
        .status-bar {
            padding: 12px 20px;
            background-color: #e6f2ff;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #2a5298;
        }
        
        .logout-btn {
            background-color: #d9534f;
        }
        
        .logout-btn:hover {
            background-color: #c9302c;
        }
        
        .settings-section {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
            display: none;
        }
        
        .settings-section h3 {
            margin-top: 0;
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .settings-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .settings-form h4 {
            margin-top: 0;
            color: #2a5298;
            margin-bottom: 15px;
        }
        
        .settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal h3 {
            margin-top: 0;
            color: #1e3c72;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .connection-status.offline {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .connection-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .connection-status.offline .dot {
            background-color: #f44336;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .viewer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #5bc0de;
        }
        
        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }
            
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .button-group {
                width: 100%;
                justify-content: flex-start;
            }
            
            .header-info {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .event-config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header id="mainHeader">
            <h1>KOMPETISI ROKET AIR LABIABA INDONESIA</h1>
            <div class="header-info" id="headerInfo">
                <!-- Informasi event akan dimuat di sini -->
            </div>
        </header>
        
        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <div class="login-box">
                <h2>üöÄ Sistem Skoring Roket Air</h2>
                <p style="color: #666; margin-bottom: 30px;">Pilih mode untuk melanjutkan</p>
                
                <div class="login-options">
                    <button class="login-btn" id="operatorLoginBtn">
                        üîß Login sebagai Operator
                    </button>
                    <button class="login-btn" id="viewerLoginBtn">
                        üëÅÔ∏è Masuk sebagai Viewer
                    </button>
                </div>
                
                <div class="password-section" id="passwordSection">
                    <div class="form-group">
                        <label for="password">üîë Password Operator</label>
                        <input type="password" id="password" placeholder="Masukkan password operator">
                    </div>
                    <button class="btn btn-success" id="submitPasswordBtn" style="width: 100%;">
                        ‚úÖ Login
                    </button>
                    <button class="btn" id="backToLoginBtn" style="width: 100%; margin-top: 10px;">
                        ‚Ü©Ô∏è Kembali
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Operator Panel -->
        <div class="operator-panel" id="operatorPanel">
            <div class="panel-header">
                <h2>üîß Panel Operator - Input Data Peserta</h2>
                <div class="button-group">
                    <button class="btn btn-warning" id="settingsBtn">
                        ‚öôÔ∏è Pengaturan
                    </button>
                    <button class="btn btn-info" id="eventConfigBtn">
                        üìÖ Konfigurasi Event
                    </button>
                    <button class="btn btn-danger" id="resetDataBtn">
                        üóëÔ∏è Reset Data
                    </button>
                    <button class="btn logout-btn" id="logoutOperatorBtn">
                        üö™ Logout
                    </button>
                </div>
            </div>
            
            <div class="status-bar">
                <div>
                    <strong>Total Peserta:</strong> <span id="totalPeserta">0</span> | 
                    <strong>Status:</strong> <span id="statusOperator">Operator aktif</span>
                </div>
                <div class="connection-status" id="operatorConnectionStatus">
                    <span class="dot"></span> <span>Menyambungkan ke server...</span>
                </div>
            </div>
            
            <!-- Konfigurasi Event -->
            <div class="event-config" id="eventConfigSection">
                <h3>üìÖ Konfigurasi Event</h3>
                <div class="event-config-grid">
                    <div class="form-group">
                        <label for="tingkat">Tingkat Kompetisi</label>
                        <input type="text" id="tingkat" value="Regional/ Nasional 2026">
                    </div>
                    
                    <div class="form-group">
                        <label for="provinsi">Daerah / Provinsi</label>
                        <input type="text" id="provinsi" value="Jawa Tengah">
                    </div>
                    
                    <div class="form-group">
                        <label for="tanggal">Tanggal Pelaksanaan</label>
                        <input type="date" id="tanggal" value="2026-08-15">
                    </div>
                    
                    <div class="form-group">
                        <label for="lokasi">Tempat Pelaksanaan</label>
                        <input type="text" id="lokasi" value="Gelora Bung Karno, Jakarta">
                    </div>
                </div>
                <button class="btn btn-success" id="updateEventBtn" style="margin-top: 15px;">
                    üîÑ Update Informasi Event
                </button>
            </div>
            
            <!-- Settings Section -->
            <div class="settings-section" id="settingsSection">
                <h3>‚öôÔ∏è Pengaturan Operator</h3>
                <div class="settings-grid">
                    <div class="settings-form">
                        <h4>üîë Ganti Password</h4>
                        <div class="form-group">
                            <label for="currentPassword">Password Saat Ini</label>
                            <input type="password" id="currentPassword">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password Baru</label>
                            <input type="password" id="newPassword">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Konfirmasi Password Baru</label>
                            <input type="password" id="confirmPassword">
                        </div>
                        <div class="settings-buttons">
                            <button class="btn btn-success" id="savePasswordBtn">
                                üíæ Simpan Password
                            </button>
                            <button class="btn btn-danger" id="cancelPasswordBtn">
                                ‚ùå Batal
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-form">
                        <h4>üì• Ekspor Data</h4>
                        <p>Unduh data peserta dalam berbagai format:</p>
                        <div class="settings-buttons">
                            <button class="btn" id="exportExcelBtn">
                                üìä Export ke Excel
                            </button>
                            <button class="btn" id="exportPDFBtn">
                                üìÑ Export ke PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-form">
                        <h4>‚ÑπÔ∏è Informasi Sistem</h4>
                        <p><strong>Versi:</strong> 1.0.0</p>
                        <p><strong>Peserta Terdaftar:</strong> <span id="infoPesertaCount">0</span></p>
                        <p><strong>Kapasitas Maksimal:</strong> 500 peserta</p>
                        <p><strong>Terakhir Update:</strong> <span id="lastUpdate">-</span></p>
                    </div>
                </div>
            </div>
            
            <div class="input-section">
                <div class="manual-input">
                    <h3>‚úèÔ∏è Input Data Manual</h3>
                    <div class="form-group">
                        <label for="namaPeserta">Nama Peserta</label>
                        <input type="text" id="namaPeserta" placeholder="Masukkan nama peserta">
                    </div>
                    <div class="form-group">
                        <label for="nomorRoket">Nomor Roket / Peluncuran</label>
                        <input type="text" id="nomorRoket" placeholder="Misal: RKT-001">
                    </div>
                    <div class="form-group">
                        <label for="asalSekolah">Asal Sekolah</label>
                        <input type="text" id="asalSekolah" placeholder="Nama sekolah">
                    </div>
                    <div class="form-group">
                        <label for="daerahSekolah">Daerah Sekolah</label>
                        <input type="text" id="daerahSekolah" placeholder="Daerah asal sekolah">
                    </div>
                    <button class="btn btn-success" id="tambahPesertaBtn">
                        ‚ûï Tambah Peserta
                    </button>
                </div>
                
                <div class="file-upload">
                    <h3>üì§ Upload Data dari Excel</h3>
                    <p>Format file Excel harus memiliki kolom: <strong>Nama, NoRoket, Sekolah, Daerah</strong></p>
                    <div class="form-group">
                        <label for="excelFile">Pilih File Excel (.xlsx, .xls, .csv)</label>
                        <input type="file" id="excelFile" accept=".xlsx, .xls, .csv">
                    </div>
                    
                    <div class="file-upload-preview" id="filePreview">
                        <h4>Preview Data:</h4>
                        <div id="previewTable"></div>
                    </div>
                    
                    <div class="upload-status" id="uploadStatus"></div>
                    
                    <button class="btn btn-success" id="uploadExcelBtn">
                        ‚¨ÜÔ∏è Upload Data ke Sistem
                    </button>
                    <button class="btn btn-warning" id="clearPreviewBtn" style="display:none; margin-top: 10px;">
                        ‚ùå Hapus Preview
                    </button>
                    
                    <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                        üì• Download template: 
                        <a href="#" id="downloadTemplate" style="color: #2a5298; text-decoration: underline;">
                            template_data_peserta.xlsx
                        </a>
                    </p>
                </div>
            </div>
            
            <div class="panel-header">
                <h2>üìã Daftar Peserta (500 peserta maksimal)</h2>
                <div class="button-group">
                    <button class="btn" id="showSettingsBtn">
                        ‚öôÔ∏è Tampilkan Pengaturan
                    </button>
                    <button class="btn" id="hideSettingsBtn" style="display:none;">
                        ‚ùå Sembunyikan Pengaturan
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="dataPeserta">
                    <thead>
                        <tr>
                            <th width="50">No</th>
                            <th width="120">Nomor Roket</th>
                            <th width="200">Nama Peserta</th>
                            <th width="250">Sekolah</th>
                            <th width="150">Daerah</th>
                            <th width="120">Peluncuran 1 (m)</th>
                            <th width="120">Peluncuran 2 (m)</th>
                            <th width="120">Skor Terbaik (m)</th>
                            <th width="80">Ranking</th>
                            <th width="100">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="pesertaTableBody">
                        <!-- Data peserta akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Viewer Panel -->
        <div class="viewer-panel" id="viewerPanel">
            <div class="panel-header">
                <h2>üëÅÔ∏è Hasil Kompetisi Roket Air - Tampilan Viewer</h2>
                <div class="button-group">
                    <button class="btn logout-btn" id="logoutViewerBtn">
                        üö™ Keluar
                    </button>
                </div>
            </div>
            
            <div class="viewer-info">
                <div>
                    <strong>Total Peserta:</strong> <span id="totalPesertaViewer">0</span> | 
                    <strong>Update Terakhir:</strong> <span id="updateStatus">Menyambungkan...</span>
                </div>
                <div class="connection-status" id="viewerConnectionStatus">
                    <span class="dot"></span> <span>Menyambungkan...</span>
                </div>
            </div>
            
            <div class="table-container">
                <table id="dataPesertaViewer">
                    <thead>
                        <tr>
                            <th width="50">Ranking</th>
                            <th width="120">Nomor Roket</th>
                            <th width="200">Nama Peserta</th>
                            <th width="250">Sekolah</th>
                            <th width="150">Daerah</th>
                            <th width="120">Peluncuran 1 (m)</th>
                            <th width="120">Peluncuran 2 (m)</th>
                            <th width="120">Skor Terbaik (m)</th>
                        </tr>
                    </thead>
                    <tbody id="pesertaTableBodyViewer">
                        <!-- Data peserta viewer akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
            
            <div class="status-bar">
                <div style="font-size: 0.9rem; color: #666;">
                    ‚ÑπÔ∏è <strong>Catatan:</strong> Skor terbaik adalah jarak TERENDAH (terpendek). Ranking 1 adalah skor TERKECIL.
                </div>
            </div>
        </div>
        
        <!-- Modal Konfirmasi Reset Data -->
        <div class="modal-overlay" id="resetModal">
            <div class="modal">
                <h3>‚ö†Ô∏è Konfirmasi Reset Data</h3>
                <p>Apakah Anda yakin ingin mereset semua data peserta? Tindakan ini akan menghapus:</p>
                <ul>
                    <li>Semua data peserta (nama, sekolah, skor)</li>
                    <li>Semua hasil peluncuran</li>
                    <li>Semua ranking yang telah dibuat</li>
                </ul>
                <p><strong>Tindakan ini tidak dapat dibatalkan!</strong></p>
                <div class="modal-buttons">
                    <button class="btn btn-danger" id="confirmResetBtn">
                        ‚úÖ Ya, Reset Semua Data
                    </button>
                    <button class="btn" id="cancelResetBtn">
                        ‚ùå Batal
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Aplikasi Skoring Kompetisi Roket Air Labiaba Indonesia &copy; 2026</p>
            <p>Sistem real-time dengan Firebase | Versi 2.0</p>
        </footer>
    </div>

    <script>
        // ==================== KONFIGURASI FIREBASE ANDA ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCe_8PKBaqGL-w8rqPpQIyRaCDAB7wJDOo",
            authDomain: "kompetisi-roket-air.firebaseapp.com",
            projectId: "kompetisi-roket-air",
            storageBucket: "kompetisi-roket-air.firebasestorage.app",
            messagingSenderId: "185264392390",
            appId: "1:185264392390:web:49a398e81cd1b92f762fc7"
        };
        
        // ==================== JANGAN UBAH KODE DI BAWAH INI ====================
        
        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Data aplikasi
        let pesertaData = [];
        let eventInfo = {
            tingkat: "Regional/ Nasional 2026",
            provinsi: "Jawa Tengah",
            tanggal: "2026-08-15",
            lokasi: "Gelora Bung Karno, Jakarta"
        };
        let currentPassword = "rocket2026";
        let isOperatorLoggedIn = false;
        let isViewerLoggedIn = false;
        let unsubscribePeserta = null;
        let unsubscribeEvent = null;
        let uploadedExcelData = []; // Untuk menyimpan data dari Excel sementara
        
        // ==================== FUNGSI UTAMA ====================
        
        // Load data dari Firebase saat aplikasi dimulai
        async function loadInitialData() {
            try {
                updateConnectionStatus("Mengambil data dari server...", "loading");
                
                // Coba ambil data peserta
                const pesertaDoc = await db.collection("kompetisi").doc("peserta").get();
                if (pesertaDoc.exists) {
                    pesertaData = pesertaDoc.data().data || [];
                    console.log("Data peserta dimuat:", pesertaData.length, "peserta");
                    hitungRanking(); // Hitung ranking saat data dimuat
                } else {
                    console.log("Belum ada data peserta, membuat data kosong");
                    await db.collection("kompetisi").doc("peserta").set({
                        data: [],
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                        _operatorToken: "ROKET2026_LABIABA"
                    });
                }
                
                // Coba ambil event info
                const eventDoc = await db.collection("kompetisi").doc("event").get();
                if (eventDoc.exists) {
                    eventInfo = eventDoc.data();
                    console.log("Event info dimuat:", eventInfo);
                } else {
                    console.log("Belum ada event info, membuat default");
                    await db.collection("kompetisi").doc("event").set({
                        ...eventInfo,
                        _operatorToken: "ROKET2026_LABIABA"
                    });
                }
                
                // Coba ambil password
                const passwordDoc = await db.collection("kompetisi").doc("config").get();
                if (passwordDoc.exists && passwordDoc.data().password) {
                    currentPassword = passwordDoc.data().password;
                }
                
                updateConnectionStatus("Terhubung ke server", "connected");
                updateHeaderInfo();
                updateEventForm();
                
            } catch (error) {
                console.error("Error loading data:", error);
                updateConnectionStatus("Gagal menyambung ke server", "disconnected");
                alert("‚ö†Ô∏è Gagal menyambung ke server. Periksa koneksi internet Anda.");
            }
        }
        
        // Setup real-time listeners
        function setupRealTimeListeners() {
            // Hentikan listener sebelumnya jika ada
            if (unsubscribePeserta) unsubscribePeserta();
            if (unsubscribeEvent) unsubscribeEvent();
            
            // Listener untuk data peserta
            unsubscribePeserta = db.collection("kompetisi").doc("peserta")
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const newData = doc.data().data || [];
                        if (JSON.stringify(pesertaData) !== JSON.stringify(newData)) {
                            pesertaData = newData;
                            console.log("üì° Data peserta diperbarui:", pesertaData.length, "peserta");
                            
                            // HITUNG RANKING SETIAP KALI DATA BERUBAH
                            hitungRanking();
                            
                            if (isOperatorLoggedIn) {
                                updateOperatorTable();
                            }
                            if (isViewerLoggedIn) {
                                updateViewerTable();
                            }
                            
                            updateConnectionStatus("Data diperbarui", "connected");
                        }
                    }
                }, (error) => {
                    console.error("Listener error:", error);
                    updateConnectionStatus("Koneksi terputus", "disconnected");
                });
            
            // Listener untuk event info
            unsubscribeEvent = db.collection("kompetisi").doc("event")
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const newEventInfo = doc.data();
                        if (JSON.stringify(eventInfo) !== JSON.stringify(newEventInfo)) {
                            eventInfo = newEventInfo;
                            console.log("üì° Event info diperbarui");
                            updateHeaderInfo();
                            updateEventForm();
                        }
                    }
                });
        }
        
        // Simpan data peserta ke Firebase
        async function savePesertaData() {
            try {
                await db.collection("kompetisi").doc("peserta").set({
                    data: pesertaData,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    _operatorToken: "ROKET2026_LABIABA"
                });
                console.log("‚úÖ Data peserta disimpan.");
            } catch (error) {
                console.error("Gagal menyimpan data peserta:", error);
                alert("Gagal menyimpan data. Pastikan Anda adalah operator yang sah.");
            }
        }
        
        // Simpan event info ke Firebase
        async function saveEventInfo() {
            try {
                // Ambil nilai dari form
                eventInfo.tingkat = document.getElementById("tingkat").value;
                eventInfo.provinsi = document.getElementById("provinsi").value;
                eventInfo.tanggal = document.getElementById("tanggal").value;
                eventInfo.lokasi = document.getElementById("lokasi").value;
                
                // Simpan ke Firestore DENGAN TOKEN
                await db.collection("kompetisi").doc("event").set({
                    ...eventInfo,
                    _operatorToken: "ROKET2026_LABIABA"
                });
                console.log("‚úÖ Event info disimpan.");
                alert("Informasi event berhasil diperbarui!");
            } catch (error) {
                console.error("Gagal menyimpan event info:", error);
                alert("Gagal memperbarui informasi event.");
            }
        }
        
        // Simpan password ke Firebase
        async function savePassword(newPassword) {
            try {
                await db.collection("kompetisi").doc("config").set({
                    password: newPassword,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    _operatorToken: "ROKET2026_LABIABA"
                });
                currentPassword = newPassword;
                console.log("‚úÖ Password diperbarui.");
            } catch (error) {
                console.error("Gagal menyimpan password:", error);
            }
        }
        
        // ==================== FUNGSI UPLOAD EXCEL (DIPERBAIKI) ====================
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Reset preview
            clearPreview();
            
            // Validasi file
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                showUploadStatus("‚ùå Format file tidak didukung. Gunakan file Excel (.xlsx, .xls) atau CSV.", "error");
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                showUploadStatus("‚ùå File terlalu besar. Maksimal 10MB.", "error");
                return;
            }
            
            showUploadStatus("üìñ Membaca file Excel...", "success");
            
            // Baca file Excel dengan FileReader
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log("Membaca file Excel...");
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Ambil sheet pertama
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Konversi ke JSON (array of arrays)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length <= 1) {
                        showUploadStatus("‚ùå File kosong atau hanya berisi header.", "error");
                        return;
                    }
                    
                    console.log("Data Excel berhasil dibaca:", jsonData.length, "baris");
                    
                    // Proses data
                    processExcelData(jsonData);
                    
                } catch (error) {
                    console.error("Error membaca file Excel:", error);
                    showUploadStatus("‚ùå Gagal membaca file Excel. Pastikan format file benar.", "error");
                }
            };
            
            reader.onerror = function() {
                console.error("Error membaca file:", reader.error);
                showUploadStatus("‚ùå Gagal membaca file. Periksa file dan coba lagi.", "error");
            };
            
            // Baca file sebagai array buffer
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(excelData) {
            console.log("Processing Excel data:", excelData);
            
            // Cari header di baris pertama
            let headers = [];
            let dataStartRow = 0;
            
            // Cari baris yang berisi header
            for (let i = 0; i < Math.min(5, excelData.length); i++) {
                const row = excelData[i];
                if (row && row.length >= 3) {
                    const headerTexts = row.map(cell => String(cell || "").toLowerCase().trim());
                    if (headerTexts.some(text => text.includes('nama')) && 
                        headerTexts.some(text => text.includes('no') && text.includes('roket'))) {
                        headers = headerTexts;
                        dataStartRow = i + 1;
                        break;
                    }
                }
            }
            
            // Jika tidak ditemukan header yang valid, gunakan baris pertama
            if (headers.length === 0 && excelData.length > 0) {
                headers = excelData[0].map(cell => String(cell || "").toLowerCase().trim());
                dataStartRow = 1;
            }
            
            console.log("Headers ditemukan:", headers);
            console.log("Data mulai dari baris:", dataStartRow);
            
            // Cari indeks kolom yang diperlukan (dengan variasai nama kolom)
            const namaIndex = findColumnIndex(headers, ['nama', 'name', 'peserta', 'nama peserta']);
            const noRoketIndex = findColumnIndex(headers, ['noroket', 'no roket', 'nomor roket', 'nomor', 'no', 'roket', 'id', 'kode']);
            const sekolahIndex = findColumnIndex(headers, ['sekolah', 'school', 'asal sekolah', 'institusi', 'lembaga']);
            const daerahIndex = findColumnIndex(headers, ['daerah', 'region', 'kota', 'kabupaten', 'provinsi', 'wilayah', 'asal']);
            
            console.log("Indeks kolom:", { namaIndex, noRoketIndex, sekolahIndex, daerahIndex });
            
            // Validasi header minimal
            if (namaIndex === -1) {
                showUploadStatus("‚ùå Kolom 'Nama' tidak ditemukan dalam file Excel.", "error");
                return;
            }
            
            if (noRoketIndex === -1) {
                showUploadStatus("‚ùå Kolom 'Nomor Roket' tidak ditemukan dalam file Excel.", "error");
                return;
            }
            
            // Proses data dari baris setelah header
            uploadedExcelData = [];
            let skippedRows = 0;
            let validRows = 0;
            
            for (let i = dataStartRow; i < excelData.length; i++) {
                const row = excelData[i];
                if (!row || row.length === 0) continue;
                
                const nama = String(row[namaIndex] || "").trim();
                const nomorRoket = String(row[noRoketIndex] || "").trim();
                const sekolah = sekolahIndex !== -1 ? String(row[sekolahIndex] || "").trim() : "";
                const daerah = daerahIndex !== -1 ? String(row[daerahIndex] || "").trim() : "";
                
                // Skip baris kosong
                if (!nama && !nomorRoket && !sekolah && !daerah) {
                    skippedRows++;
                    continue;
                }
                
                // Validasi data minimal
                if (!nama || !nomorRoket) {
                    console.warn(`Baris ${i+1} dilewati: nama atau nomor roket kosong`);
                    skippedRows++;
                    continue;
                }
                
                uploadedExcelData.push({
                    nama: nama,
                    nomorRoket: nomorRoket,
                    sekolah: sekolah,
                    daerah: daerah,
                    barisAsli: i + 1
                });
                validRows++;
            }
            
            if (uploadedExcelData.length === 0) {
                showUploadStatus("‚ùå Tidak ada data valid yang ditemukan dalam file.", "error");
                return;
            }
            
            // Tampilkan preview
            showPreview(uploadedExcelData);
            
            const successMsg = `‚úÖ Berhasil membaca ${validRows} data peserta dari ${excelData.length - dataStartRow} baris data`;
            if (skippedRows > 0) {
                showUploadStatus(`${successMsg} (${skippedRows} baris dilewati karena data tidak lengkap)`, "success");
            } else {
                showUploadStatus(successMsg, "success");
            }
            
            // Tampilkan tombol clear preview
            document.getElementById("clearPreviewBtn").style.display = "block";
        }
        
        function findColumnIndex(headers, possibleNames) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i];
                for (const name of possibleNames) {
                    if (header.includes(name)) {
                        return i;
                    }
                }
            }
            return -1;
        }
        
        function showPreview(data) {
            const previewTable = document.getElementById("previewTable");
            const filePreview = document.getElementById("filePreview");
            
            let html = '<table style="width:100%; border-collapse:collapse; font-size:0.85rem;">';
            html += '<thead><tr style="background-color:#f0f0f0;">';
            html += '<th style="padding:8px; text-align:left;">No</th>';
            html += '<th style="padding:8px; text-align:left;">Nomor Roket</th>';
            html += '<th style="padding:8px; text-align:left;">Nama</th>';
            html += '<th style="padding:8px; text-align:left;">Sekolah</th>';
            html += '<th style="padding:8px; text-align:left;">Daerah</th>';
            html += '</tr></thead><tbody>';
            
            const previewLimit = Math.min(data.length, 20); // Tampilkan maksimal 20 baris
            for (let i = 0; i < previewLimit; i++) {
                const item = data[i];
                html += '<tr>';
                html += `<td style="padding:6px 8px; border-bottom:1px solid #eee;">${i + 1}</td>`;
                html += `<td style="padding:6px 8px; border-bottom:1px solid #eee;">${item.nomorRoket || '-'}</td>`;
                html += `<td style="padding:6px 8px; border-bottom:1px solid #eee;">${item.nama || '-'}</td>`;
                html += `<td style="padding:6px 8px; border-bottom:1px solid #eee;">${item.sekolah || '-'}</td>`;
                html += `<td style="padding:6px 8px; border-bottom:1px solid #eee;">${item.daerah || '-'}</td>`;
                html += '</tr>';
            }
            
            if (data.length > previewLimit) {
                html += `<tr><td colspan="5" style="padding:8px; text-align:center; font-style:italic;">
                    ... dan ${data.length - previewLimit} data lainnya
                </td></tr>`;
            }
            
            html += '</tbody></table>';
            previewTable.innerHTML = html;
            filePreview.style.display = "block";
        }
        
        function clearPreview() {
            document.getElementById("filePreview").style.display = "none";
            document.getElementById("previewTable").innerHTML = "";
            document.getElementById("uploadStatus").style.display = "none";
            document.getElementById("clearPreviewBtn").style.display = "none";
            document.getElementById("excelFile").value = "";
            uploadedExcelData = [];
        }
        
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById("uploadStatus");
            statusDiv.textContent = message;
            statusDiv.className = `upload-status ${type}`;
            statusDiv.style.display = "block";
        }
        
        async function uploadExcelData() {
            if (uploadedExcelData.length === 0) {
                showUploadStatus("‚ùå Tidak ada data untuk diupload.", "error");
                return;
            }
            
            // Validasi kapasitas
            const totalAfterUpload = pesertaData.length + uploadedExcelData.length;
            if (totalAfterUpload > 500) {
                showUploadStatus(`‚ùå Kapasitas maksimal 500 peserta. Saat ini ada ${pesertaData.length} peserta, tambahan ${uploadedExcelData.length} akan melebihi batas.`, "error");
                return;
            }
            
            // Cek duplikat nomor roket
            const existingNumbers = pesertaData.map(p => p.nomorRoket);
            const duplicateNumbers = uploadedExcelData.filter(item => 
                existingNumbers.includes(item.nomorRoket)
            ).map(item => item.nomorRoket);
            
            let newData = uploadedExcelData;
            
            if (duplicateNumbers.length > 0) {
                const confirmUpload = confirm(
                    `‚ö†Ô∏è ${duplicateNumbers.length} nomor roket sudah terdaftar:\n${duplicateNumbers.slice(0, 5).join(', ')}${duplicateNumbers.length > 5 ? '...' : ''}\n\nLanjutkan upload? Data lama akan dipertahankan.`
                );
                if (!confirmUpload) return;
                
                // Filter data yang nomor roketnya belum ada
                newData = uploadedExcelData.filter(item => 
                    !existingNumbers.includes(item.nomorRoket)
                );
            }
            
            if (newData.length === 0) {
                showUploadStatus("‚ùå Semua data sudah ada di sistem.", "error");
                return;
            }
            
            try {
                // Tampilkan loading
                showUploadStatus("‚è≥ Menyimpan data ke server...", "success");
                
                // Generate ID untuk data baru
                const maxId = pesertaData.length > 0 ? Math.max(...pesertaData.map(p => p.id)) : 0;
                
                // Format data untuk disimpan
                const formattedData = newData.map((item, index) => ({
                    id: maxId + index + 1,
                    nomorRoket: item.nomorRoket,
                    nama: item.nama,
                    sekolah: item.sekolah,
                    daerah: item.daerah,
                    peluncuran1: "",
                    peluncuran2: "",
                    skorTerbaik: "",
                    ranking: 0
                }));
                
                // Tambahkan ke data peserta
                pesertaData.push(...formattedData);
                
                // Simpan ke Firebase
                await savePesertaData();
                
                // Reset preview
                clearPreview();
                
                showUploadStatus(`‚úÖ Berhasil menambahkan ${formattedData.length} peserta baru! Total peserta: ${pesertaData.length}`, "success");
                
                // Update tabel
                updateOperatorTable();
                
            } catch (error) {
                console.error("Error uploading data:", error);
                showUploadStatus("‚ùå Gagal menyimpan data ke server. Periksa koneksi internet.", "error");
            }
        }
        
        function downloadTemplate() {
            try {
                // Buat data template
                const templateData = [
                    ["Nama Peserta", "Nomor Roket", "Sekolah", "Daerah"],
                    ["Budi Santoso", "RKT-001", "SMPN 1 Jakarta", "Jakarta"],
                    ["Siti Aminah", "RKT-002", "SMPN 2 Bandung", "Bandung"],
                    ["Joko Widodo", "RKT-003", "SMA 1 Surabaya", "Surabaya"],
                    ["Ani Wijaya", "RKT-004", "SMPN 3 Yogyakarta", "Yogyakarta"],
                    ["Rudi Hartono", "RKT-005", "SMK 1 Semarang", "Semarang"],
                    ["", "", "", ""],
                    ["CATATAN:", "", "", ""],
                    ["1. Isi data mulai baris ke-2", "", "", ""],
                    ["2. Nama kolom harus sesuai", "", "", ""],
                    ["3. Nomor roket harus unik", "", "", ""]
                ];
                
                // Buat workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(templateData);
                
                // Atur lebar kolom
                const wscols = [
                    { wch: 25 }, // Nama
                    { wch: 15 }, // NoRoket
                    { wch: 30 }, // Sekolah
                    { wch: 20 }  // Daerah
                ];
                ws['!cols'] = wscols;
                
                // Tambah worksheet ke workbook
                XLSX.utils.book_append_sheet(wb, ws, "Template Peserta");
                
                // Simpan file
                XLSX.writeFile(wb, "template_data_peserta_roket_air.xlsx");
                
                showUploadStatus("‚úÖ Template berhasil diunduh! Silakan buka file untuk mengisi data.", "success");
                
            } catch (error) {
                console.error("Error creating template:", error);
                showUploadStatus("‚ùå Gagal membuat template. Periksa browser Anda.", "error");
            }
        }
        
        // ==================== FUNGSI HELPER ====================
        
        function updateConnectionStatus(message, status) {
            const operatorStatus = document.getElementById("operatorConnectionStatus");
            const viewerStatus = document.getElementById("viewerConnectionStatus");
            
            if (operatorStatus) {
                operatorStatus.innerHTML = `<span class="dot"></span> <span>${message}</span>`;
                if (status === "connected") {
                    operatorStatus.classList.remove("offline");
                } else if (status === "disconnected") {
                    operatorStatus.classList.add("offline");
                }
            }
            
            if (viewerStatus) {
                viewerStatus.innerHTML = `<span class="dot"></span> <span>${message}</span>`;
                if (status === "connected") {
                    viewerStatus.classList.remove("offline");
                } else if (status === "disconnected") {
                    viewerStatus.classList.add("offline");
                }
            }
            
            // Update timestamp untuk viewer
            if (isViewerLoggedIn && status === "connected") {
                const now = new Date();
                document.getElementById("updateStatus").textContent = 
                    now.toLocaleTimeString("id-ID", { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
        }
        
        function updateHeaderInfo() {
            const headerInfo = document.getElementById("headerInfo");
            if (!headerInfo) return;
            
            headerInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Tingkat Kompetisi</div>
                    <div class="info-value">${eventInfo.tingkat || "Belum diatur"}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Daerah / Provinsi</div>
                    <div class="info-value">${eventInfo.provinsi || "Belum diatur"}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Tanggal Pelaksanaan</div>
                    <div class="info-value">${formatDate(eventInfo.tanggal) || "Belum diatur"}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Tempat Pelaksanaan</div>
                    <div class="info-value">${eventInfo.lokasi || "Belum diatur"}</div>
                </div>
            `;
        }
        
        function formatDate(dateString) {
            if (!dateString) return "";
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString("id-ID", {
                    day: "2-digit",
                    month: "long",
                    year: "numeric"
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function updateEventForm() {
            const tingkat = document.getElementById("tingkat");
            const provinsi = document.getElementById("provinsi");
            const tanggal = document.getElementById("tanggal");
            const lokasi = document.getElementById("lokasi");
            
            if (tingkat) tingkat.value = eventInfo.tingkat || "";
            if (provinsi) provinsi.value = eventInfo.provinsi || "";
            if (tanggal) tanggal.value = eventInfo.tanggal || "";
            if (lokasi) lokasi.value = eventInfo.lokasi || "";
        }
        
        function hitungSkorTerbaik(p1, p2) {
            if (p1 === "" && p2 === "") return "";
            if (p1 === "") return p2;
            if (p2 === "") return p1;
            
            const num1 = parseFloat(p1);
            const num2 = parseFloat(p2);
            
            // Return nilai TERKECIL (jarak terpendek menang)
            return Math.min(num1, num2).toString();
        }
        
        function hitungRanking() {
            console.log("üîÑ Mulai hitung ranking...");
            
            // 1. Salin data dan konversi skor ke angka
            const dataUntukDiurutkan = pesertaData.map(p => {
                const skorNum = p.skorTerbaik && p.skorTerbaik !== "" ? 
                               parseFloat(p.skorTerbaik) : 
                               Infinity; // Peserta tanpa skor diberi nilai tak terhingga
                return { ...p, skorNum: skorNum };
            });
            
            // 2. Urutkan berdasarkan: 1) skor angka TERKECIL ranking 1, 2) id (jika skor sama)
            dataUntukDiurutkan.sort((a, b) => {
                if (a.skorNum !== b.skorNum) return a.skorNum - b.skorNum; // PERUBAHAN PENTING!
                return a.id - b.id;
            });
            
            // 3. Beri ranking (dengan tie-handling sederhana)
            let rank = 1;
            let lastScore = null;
            let rankCounter = 1;
            
            for (let i = 0; i < dataUntukDiurutkan.length; i++) {
                const peserta = dataUntukDiurutkan[i];
                
                // Skip peserta tanpa skor
                if (peserta.skorNum === Infinity) {
                    peserta.ranking = 0;
                    lastScore = null;
                    continue;
                }
                
                if (lastScore !== null && peserta.skorNum === lastScore) {
                    // Skor sama dengan sebelumnya, beri ranking yang sama
                    peserta.ranking = rank;
                } else {
                    // Skor berbeda, beri ranking baru
                    peserta.ranking = rankCounter;
                    rank = rankCounter;
                }
                
                lastScore = peserta.skorNum;
                rankCounter++;
                
                // Update ke array utama
                const index = pesertaData.findIndex(p => p.id === peserta.id);
                if (index !== -1) {
                    pesertaData[index].ranking = peserta.ranking;
                }
            }
            
            // Beri ranking 0 untuk peserta tanpa skor
            pesertaData.forEach(p => {
                if (!p.skorTerbaik || p.skorTerbaik === "") {
                    p.ranking = 0;
                }
            });
            
            // 4. Urutkan pesertaData berdasarkan ranking untuk tampilan rapi
            pesertaData.sort((a, b) => {
                if (a.ranking === b.ranking) return a.id - b.id;
                if (a.ranking === 0) return 1; // Peserta tanpa skor di akhir
                if (b.ranking === 0) return -1;
                return a.ranking - b.ranking;
            });
            
            console.log("‚úÖ Hasil ranking:", pesertaData.map(p => 
                `${p.nama}: skor=${p.skorTerbaik}, ranking=${p.ranking}`
            ));
        }
        
        // ==================== FUNGSI TAMPILAN ====================
        
        function updateOperatorTable() {
            const tbody = document.getElementById("pesertaTableBody");
            if (!tbody) return;
            
            hitungRanking();
            
            console.log("üìä Data untuk tabel operator:", pesertaData);
            
            // Urutkan berdasarkan ranking
            const sortedPeserta = [...pesertaData].sort((a, b) => {
                if (a.ranking === b.ranking) return a.id - b.id;
                if (a.ranking === 0) return 1; // Peserta tanpa skor di akhir
                if (b.ranking === 0) return -1;
                return a.ranking - b.ranking;
            });
            
            tbody.innerHTML = "";
            
            sortedPeserta.forEach((peserta, index) => {
                const row = document.createElement("tr");
                
                // Highlight untuk 50 teratas
                if (index < 50) {
                    row.classList.add("top-50");
                }
                
                // Highlight ranking 1, 2, 3
                if (peserta.ranking === 1) row.classList.add("ranking-1");
                if (peserta.ranking === 2) row.classList.add("ranking-2");
                if (peserta.ranking === 3) row.classList.add("ranking-3");
                
                // Tentukan apakah input adalah skor terbaik
                const isPeluncuran1Best = peserta.peluncuran1 && peserta.skorTerbaik && 
                                         parseFloat(peserta.peluncuran1) === parseFloat(peserta.skorTerbaik);
                const isPeluncuran2Best = peserta.peluncuran2 && peserta.skorTerbaik && 
                                         parseFloat(peserta.peluncuran2) === parseFloat(peserta.skorTerbaik);
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${peserta.nomorRoket || ""}</td>
                    <td>${peserta.nama || ""}</td>
                    <td>${peserta.sekolah || ""}</td>
                    <td>${peserta.daerah || ""}</td>
                    <td>
                        <input type="number" step="0.01" min="0" 
                               class="score-input ${isPeluncuran1Best ? 'best-score' : ''}" 
                               data-id="${peserta.id}" 
                               data-type="peluncuran1" 
                               value="${peserta.peluncuran1 || ""}"
                               placeholder="0.00">
                    </td>
                    <td>
                        <input type="number" step="0.01" min="0" 
                               class="score-input ${isPeluncuran2Best ? 'best-score' : ''}" 
                               data-id="${peserta.id}" 
                               data-type="peluncuran2" 
                               value="${peserta.peluncuran2 || ""}"
                               placeholder="0.00">
                    </td>
                    <td class="${peserta.skorTerbaik ? 'best-score' : ''}">${peserta.skorTerbaik || ""}</td>
                    <td>${peserta.ranking || "0"}</td>
                    <td>
                        <button class="btn btn-danger btn-sm hapus-peserta" data-id="${peserta.id}">
                            ‚ùå Hapus
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update counters
            document.getElementById("totalPeserta").textContent = pesertaData.length;
            document.getElementById("infoPesertaCount").textContent = pesertaData.length;
            document.getElementById("lastUpdate").textContent = new Date().toLocaleString("id-ID");
            
            // Add event listeners untuk input skor
            document.querySelectorAll(".score-input").forEach(input => {
                input.addEventListener("change", function() {
                    const id = parseInt(this.dataset.id);
                    const type = this.dataset.type;
                    const value = this.value;
                    
                    updateSkorPeserta(id, type, value);
                });
            });
            
            // Add event listeners untuk tombol hapus
            document.querySelectorAll(".hapus-peserta").forEach(button => {
                button.addEventListener("click", function() {
                    const id = parseInt(this.dataset.id);
                    if (confirm("Apakah Anda yakin ingin menghapus peserta ini?")) {
                        hapusPeserta(id);
                    }
                });
            });
        }
        
        function updateViewerTable() {
            const tbody = document.getElementById("pesertaTableBodyViewer");
            if (!tbody) return;
            
            // Pastikan ranking sudah dihitung
            hitungRanking();
            
            // Urutkan berdasarkan ranking
            const sortedPeserta = [...pesertaData].sort((a, b) => {
                if (a.ranking === b.ranking) return a.id - b.id;
                if (a.ranking === 0) return 1; // Peserta tanpa skor di akhir
                if (b.ranking === 0) return -1;
                return a.ranking - b.ranking;
            });
            
            tbody.innerHTML = "";
            
            sortedPeserta.forEach((peserta, index) => {
                const row = document.createElement("tr");
                
                // Highlight untuk 50 teratas
                if (index < 50) {
                    row.classList.add("top-50");
                }
                
                // Highlight ranking 1, 2, 3
                if (peserta.ranking === 1) row.classList.add("ranking-1");
                if (peserta.ranking === 2) row.classList.add("ranking-2");
                if (peserta.ranking === 3) row.classList.add("ranking-3");
                
                row.innerHTML = `
                    <td>${peserta.ranking || "0"}</td>
                    <td>${peserta.nomorRoket || ""}</td>
                    <td>${peserta.nama || ""}</td>
                    <td>${peserta.sekolah || ""}</td>
                    <td>${peserta.daerah || ""}</td>
                    <td>${peserta.peluncuran1 || ""}</td>
                    <td>${peserta.peluncuran2 || ""}</td>
                    <td class="${peserta.skorTerbaik ? 'best-score' : ''}">${peserta.skorTerbaik || ""}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById("totalPesertaViewer").textContent = pesertaData.length;
        }
        
        // ==================== FUNGSI OPERASI DATA ====================
        
        async function tambahPeserta() {
            const nama = document.getElementById("namaPeserta").value.trim();
            const nomorRoket = document.getElementById("nomorRoket").value.trim();
            const sekolah = document.getElementById("asalSekolah").value.trim();
            const daerah = document.getElementById("daerahSekolah").value.trim();
            
            if (!nama || !nomorRoket || !sekolah || !daerah) {
                alert("‚ùå Harap isi semua data peserta!");
                return;
            }
            
            // Cek duplikat nomor roket
            if (pesertaData.some(p => p.nomorRoket === nomorRoket)) {
                alert(`‚ùå Nomor roket "${nomorRoket}" sudah digunakan!`);
                return;
            }
            
            // Cek batas 500 peserta
            if (pesertaData.length >= 500) {
                alert("‚ùå Maksimal 500 peserta telah tercapai!");
                return;
            }
            
            // Generate ID baru
            const newId = pesertaData.length > 0 ? Math.max(...pesertaData.map(p => p.id)) + 1 : 1;
            
            // Tambah peserta baru
            const pesertaBaru = {
                id: newId,
                nomorRoket: nomorRoket,
                nama: nama,
                sekolah: sekolah,
                daerah: daerah,
                peluncuran1: "",
                peluncuran2: "",
                skorTerbaik: "",
                ranking: 0
            };
            
            pesertaData.push(pesertaBaru);
            
            // Reset form
            document.getElementById("namaPeserta").value = "";
            document.getElementById("nomorRoket").value = "";
            document.getElementById("asalSekolah").value = "";
            document.getElementById("daerahSekolah").value = "";
            
            // Simpan ke Firebase
            await savePesertaData();
            
            alert(`‚úÖ Peserta "${nama}" berhasil ditambahkan!`);
        }
        
        async function updateSkorPeserta(id, type, value) {
            const index = pesertaData.findIndex(p => p.id === id);
            if (index === -1) return;
            
            if (type === "peluncuran1") {
                pesertaData[index].peluncuran1 = value;
            } else if (type === "peluncuran2") {
                pesertaData[index].peluncuran2 = value;
            }
            
            // Hitung skor terbaik (TERKECIL/TERENDAH)
            pesertaData[index].skorTerbaik = hitungSkorTerbaik(
                pesertaData[index].peluncuran1,
                pesertaData[index].peluncuran2
            );
            
            console.log(`üìä Update skor peserta ${id}:`, {
                peluncuran1: pesertaData[index].peluncuran1,
                peluncuran2: pesertaData[index].peluncuran2,
                skorTerbaik: pesertaData[index].skorTerbaik
            });
            
            // HITUNG ULANG RANKING SEMUA PESERTA
            hitungRanking();
            
            // Simpan ke Firebase
            await savePesertaData();
        }
        
        async function hapusPeserta(id) {
            pesertaData = pesertaData.filter(p => p.id !== id);
            await savePesertaData();
            alert("‚úÖ Peserta berhasil dihapus!");
        }
        
        async function gantiPassword() {
            const currentPass = document.getElementById("currentPassword").value;
            const newPass = document.getElementById("newPassword").value;
            const confirmPass = document.getElementById("confirmPassword").value;
            
            if (currentPass !== currentPassword) {
                alert("‚ùå Password saat ini salah!");
                return;
            }
            
            if (newPass !== confirmPass) {
                alert("‚ùå Password baru dan konfirmasi tidak cocok!");
                return;
            }
            
            if (newPass.length < 6) {
                alert("‚ùå Password baru harus minimal 6 karakter!");
                return;
            }
            
            await savePassword(newPass);
            
            // Reset form
            document.getElementById("currentPassword").value = "";
            document.getElementById("newPassword").value = "";
            document.getElementById("confirmPassword").value = "";
            
            alert("‚úÖ Password berhasil diubah!");
        }
        
        async function resetAllData() {
            if (!confirm("‚ö†Ô∏è APAKAH ANDA YAKIN?\n\nIni akan menghapus SEMUA data peserta dan tidak dapat dikembalikan!")) {
                return;
            }
            
            pesertaData = [];
            await savePesertaData();
            
            // Tutup modal
            document.getElementById("resetModal").style.display = "none";
            
            alert("‚úÖ Semua data telah direset!");
        }
        
        function exportToExcel() {
            if (pesertaData.length === 0) {
                alert("‚ùå Tidak ada data untuk diekspor!");
                return;
            }
            
            // Urutkan berdasarkan ranking untuk export
            const sortedPeserta = [...pesertaData].sort((a, b) => {
                if (a.ranking === b.ranking) return a.id - b.id;
                return a.ranking - b.ranking;
            });
            
            // Siapkan data untuk Excel
            const excelData = [
                ["No", "Nomor Roket", "Nama Peserta", "Sekolah", "Daerah", "Peluncuran 1 (m)", "Peluncuran 2 (m)", "Skor Terbaik (m)", "Ranking"]
            ];
            
            sortedPeserta.forEach((peserta, index) => {
                excelData.push([
                    index + 1,
                    peserta.nomorRoket || "",
                    peserta.nama || "",
                    peserta.sekolah || "",
                    peserta.daerah || "",
                    peserta.peluncuran1 || "",
                    peserta.peluncuran2 || "",
                    peserta.skorTerbaik || "",
                    peserta.ranking || "0"
                ]);
            });
            
            // Buat workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Atur lebar kolom
            const wscols = [
                { wch: 5 },    // No
                { wch: 15 },   // Nomor Roket
                { wch: 25 },   // Nama
                { wch: 30 },   // Sekolah
                { wch: 20 },   // Daerah
                { wch: 15 },   // Peluncuran 1
                { wch: 15 },   // Peluncuran 2
                { wch: 15 },   // Skor Terbaik
                { wch: 10 }    // Ranking
            ];
            ws['!cols'] = wscols;
            
            // Tambah worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Peserta");
            
            // Simpan file
            const timestamp = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `data_peserta_roket_${timestamp}.xlsx`);
            
            alert("‚úÖ Data berhasil diekspor ke Excel!");
        }
        
        function exportToPDF() {
            if (pesertaData.length === 0) {
                alert("‚ùå Tidak ada data untuk diekspor!");
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                
                // Judul dokumen
                doc.setFontSize(18);
                doc.text(`Hasil Kompetisi Roket Air ${eventInfo.tingkat}`, 14, 15);
                doc.setFontSize(11);
                doc.text(`${eventInfo.provinsi}, ${formatDate(eventInfo.tanggal)} - ${eventInfo.lokasi}`, 14, 22);
                
                // Siapkan data untuk tabel
                const headers = [['Ranking', 'No Roket', 'Nama Peserta', 'Sekolah', 'Daerah', 'Peluncuran 1', 'Peluncuran 2', 'Skor Terbaik']];
                
                // Urutkan data berdasarkan ranking untuk PDF
                const sortedPeserta = [...pesertaData].sort((a, b) => {
                    if (a.ranking === b.ranking) return a.id - b.id;
                    return a.ranking - b.ranking;
                });
                
                const data = sortedPeserta.map(p => [
                    p.ranking || '',
                    p.nomorRoket || '',
                    p.nama || '',
                    p.sekolah || '',
                    p.daerah || '',
                    p.peluncuran1 || '',
                    p.peluncuran2 || '',
                    p.skorTerbaik || ''
                ]);
                
                // Buat tabel
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: 30,
                    theme: 'grid',
                    styles: { 
                        fontSize: 9,
                        cellPadding: 3
                    },
                    headStyles: { 
                        fillColor: [41, 82, 152],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Halaman ${i} dari ${pageCount}`, doc.internal.pageSize.width - 40, doc.internal.pageSize.height - 10);
                    doc.text(`Dicetak: ${new Date().toLocaleString('id-ID')}`, 14, doc.internal.pageSize.height - 10);
                }
                
                // Simpan file
                const timestamp = new Date().toISOString().split('T')[0];
                doc.save(`hasil_roket_air_${timestamp}.pdf`);
                
                alert(`‚úÖ PDF berhasil diunduh!`);
                
            } catch (error) {
                console.error("Error membuat PDF:", error);
                alert("‚ùå Gagal membuat PDF. Pastikan koneksi internet aktif.");
            }
        }
        
        // ==================== EVENT LISTENERS (DIPERBAIKI) ====================
        
        document.addEventListener("DOMContentLoaded", function() {
            console.log("üöÄ Aplikasi Roket Air dimuat");
            
            // Load data awal
            loadInitialData();
            
            // Login Operator
            document.getElementById("operatorLoginBtn").addEventListener("click", function() {
                document.getElementById("passwordSection").style.display = "block";
            });
            
            // Kembali dari password
            document.getElementById("backToLoginBtn").addEventListener("click", function() {
                document.getElementById("passwordSection").style.display = "none";
            });
            
            // Submit password
            document.getElementById("submitPasswordBtn").addEventListener("click", function() {
                const password = document.getElementById("password").value;
                
                if (password === currentPassword) {
                    isOperatorLoggedIn = true;
                    document.getElementById("loginSection").style.display = "none";
                    document.getElementById("operatorPanel").style.display = "block";
                    document.getElementById("password").value = "";
                    document.getElementById("passwordSection").style.display = "none";
                    
                    setupRealTimeListeners();
                    updateOperatorTable();
                    
                    console.log("üîß Operator logged in");
                } else {
                    alert("‚ùå Password salah!");
                }
            });
            
            // Login Viewer
            document.getElementById("viewerLoginBtn").addEventListener("click", function() {
                isViewerLoggedIn = true;
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("viewerPanel").style.display = "block";
                
                setupRealTimeListeners();
                updateViewerTable();
                
                console.log("üëÅÔ∏è Viewer logged in");
            });
            
            // Logout Operator
            document.getElementById("logoutOperatorBtn").addEventListener("click", function() {
                isOperatorLoggedIn = false;
                document.getElementById("operatorPanel").style.display = "none";
                document.getElementById("loginSection").style.display = "flex";
                
                if (unsubscribePeserta) unsubscribePeserta();
                if (unsubscribeEvent) unsubscribeEvent();
                
                console.log("üîß Operator logged out");
            });
            
            // Logout Viewer
            document.getElementById("logoutViewerBtn").addEventListener("click", function() {
                isViewerLoggedIn = false;
                document.getElementById("viewerPanel").style.display = "none";
                document.getElementById("loginSection").style.display = "flex";
                
                if (unsubscribePeserta) unsubscribePeserta();
                if (unsubscribeEvent) unsubscribeEvent();
                
                console.log("üëÅÔ∏è Viewer logged out");
            });
            
            // Tampilkan/sembunyikan settings
            document.getElementById("settingsBtn").addEventListener("click", function() {
                const settingsSection = document.getElementById("settingsSection");
                const showBtn = document.getElementById("showSettingsBtn");
                const hideBtn = document.getElementById("hideSettingsBtn");
                
                if (settingsSection.style.display === "none" || settingsSection.style.display === "") {
                    settingsSection.style.display = "block";
                    showBtn.style.display = "none";
                    hideBtn.style.display = "block";
                } else {
                    settingsSection.style.display = "none";
                    showBtn.style.display = "block";
                    hideBtn.style.display = "none";
                }
            });
            
            document.getElementById("showSettingsBtn").addEventListener("click", function() {
                document.getElementById("settingsSection").style.display = "block";
                this.style.display = "none";
                document.getElementById("hideSettingsBtn").style.display = "block";
            });
            
            document.getElementById("hideSettingsBtn").addEventListener("click", function() {
                document.getElementById("settingsSection").style.display = "none";
                this.style.display = "none";
                document.getElementById("showSettingsBtn").style.display = "block";
            });
            
            // Tampilkan/sembunyikan event config
            document.getElementById("eventConfigBtn").addEventListener("click", function() {
                const eventConfig = document.getElementById("eventConfigSection");
                if (eventConfig.style.display === "none" || eventConfig.style.display === "") {
                    eventConfig.style.display = "block";
                } else {
                    eventConfig.style.display = "none";
                }
            });
            
            // Event listeners untuk upload Excel (DIPERBAIKI)
            document.getElementById("excelFile").addEventListener("change", handleFileUpload);
            document.getElementById("uploadExcelBtn").addEventListener("click", uploadExcelData);
            document.getElementById("clearPreviewBtn").addEventListener("click", clearPreview);
            document.getElementById("downloadTemplate").addEventListener("click", function(e) {
                e.preventDefault();
                downloadTemplate();
            });
            
            // Event listeners lainnya
            document.getElementById("tambahPesertaBtn").addEventListener("click", tambahPeserta);
            document.getElementById("updateEventBtn").addEventListener("click", saveEventInfo);
            document.getElementById("savePasswordBtn").addEventListener("click", gantiPassword);
            document.getElementById("cancelPasswordBtn").addEventListener("click", function() {
                document.getElementById("currentPassword").value = "";
                document.getElementById("newPassword").value = "";
                document.getElementById("confirmPassword").value = "";
            });
            document.getElementById("exportExcelBtn").addEventListener("click", exportToExcel);
            document.getElementById("exportPDFBtn").addEventListener("click", exportToPDF);
            
            // Reset data
            document.getElementById("resetDataBtn").addEventListener("click", function() {
                document.getElementById("resetModal").style.display = "flex";
            });
            
            document.getElementById("confirmResetBtn").addEventListener("click", resetAllData);
            document.getElementById("cancelResetBtn").addEventListener("click", function() {
                document.getElementById("resetModal").style.display = "none";
            });
            
            // Tes fungsi XLSX
            console.log("XLSX library loaded:", typeof XLSX !== 'undefined' ? 'YA' : 'TIDAK');
        });
    </script>
</body>
</html>